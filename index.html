<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3B82F6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Chore Tracker</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const firebaseConfig = {
        apiKey: "AIzaSyAD5e1HimKsCRqOPPUYEDzFW4iC5eLEUP8",
        authDomain: "chore-tracker-28aac.firebaseapp.com",
        databaseURL: "https://chore-tracker-28aac-default-rtdb.firebaseio.com",
        projectId: "chore-tracker-28aac",
        storageBucket: "chore-tracker-28aac.firebasestorage.app",
        messagingSenderId: "243193335376",
        appId: "1:243193335376:web:f3d716211b914aa8304b55"
    };

    // Initialize Firebase
    let auth, db;
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      auth = firebase.auth();
      db = firebase.database();
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }

    // Icons
    const Check = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    );

    const Plus = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const Trash = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );

    const Edit = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
    );

    const LogOut = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    );

    const X = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    const Trophy = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
        <path d="M4 22h16"></path>
        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
      </svg>
    );

    const ListTodo = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <rect x="3" y="5" width="6" height="6" rx="1"></rect>
        <path d="m3 17 2 2 4-4"></path>
        <path d="M13 6h8"></path>
        <path d="M13 12h8"></path>
        <path d="M13 18h8"></path>
      </svg>
    );

    const User = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
    );

    // Helper functions
    const getDisplayName = (email, profiles) => {
      if (!email) return 'Unknown';
      const userKey = email.replace(/[.#$[\]]/g, '_');
      const profile = profiles[userKey];
      if (profile && (profile.firstName || profile.lastName)) {
        return `${profile.firstName || ''} ${profile.lastName || ''}`.trim();
      }
      return email;
    };
    const formatDate = (timestamp) => {
      if (!timestamp) return null;
      const date = new Date(timestamp);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      return `${month}/${day}/${year}`;
    };

    const calculateProgress = (lastCompleted, frequencyValue, frequencyUnit) => {
      if (!lastCompleted) return 0;
      
      const now = Date.now();
      const timeSinceCompletion = now - lastCompleted;
      
      // Convert frequency to milliseconds
      let frequencyMs;
      switch (frequencyUnit) {
        case 'hours':
          frequencyMs = frequencyValue * 60 * 60 * 1000;
          break;
        case 'days':
          frequencyMs = frequencyValue * 24 * 60 * 60 * 1000;
          break;
        case 'weeks':
          frequencyMs = frequencyValue * 7 * 24 * 60 * 60 * 1000;
          break;
        case 'months':
          frequencyMs = frequencyValue * 30 * 24 * 60 * 60 * 1000;
          break;
        case 'years':
          frequencyMs = frequencyValue * 365 * 24 * 60 * 60 * 1000;
          break;
        default:
          frequencyMs = frequencyValue * 24 * 60 * 60 * 1000;
      }
      
      const progress = 100 - (timeSinceCompletion / frequencyMs) * 100;
      return Math.max(0, Math.min(100, progress));
    };

    // Login Component
    function LoginScreen() {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [isSignUp, setIsSignUp] = useState(false);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (isSignUp) {
            await auth.createUserWithEmailAndPassword(email, password);
          } else {
            await auth.signInWithEmailAndPassword(email, password);
          }
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <h1 className="text-3xl font-bold text-gray-800 mb-2 text-center">
              Chore Tracker
            </h1>
            <p className="text-gray-600 mb-6 text-center">
              {isSignUp ? 'Create your account' : 'Sign in to continue'}
            </p>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Email
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="you@example.com"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Password
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  minLength="6"
                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="••••••••"
                />
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition disabled:opacity-50"
              >
                {loading ? 'Please wait...' : (isSignUp ? 'Sign Up' : 'Sign In')}
              </button>
            </form>

            <div className="mt-4 text-center">
              <button
                onClick={() => {
                  setIsSignUp(!isSignUp);
                  setError('');
                }}
                className="text-blue-600 hover:text-blue-700 text-sm font-medium"
              >
                {isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Task Type Selection Modal
    function TaskTypeModal({ onClose, onSelect }) {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-gray-800">Create New Task</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X />
              </button>
            </div>
            
            <div className="space-y-3">
              <button
                onClick={() => onSelect('on-demand')}
                className="w-full p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition"
              >
                <div className="font-semibold text-gray-800 mb-1">On Demand</div>
                <div className="text-sm text-gray-600">Complete as needed, tracks last completion</div>
              </button>
              
              <button
                onClick={() => onSelect('recurring')}
                className="w-full p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition"
              >
                <div className="font-semibold text-gray-800 mb-1">Recurring</div>
                <div className="text-sm text-gray-600">Set a frequency for regular completion</div>
              </button>
              
              <button
                onClick={() => onSelect('one-time')}
                className="w-full p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition"
              >
                <div className="font-semibold text-gray-800 mb-1">One-time</div>
                <div className="text-sm text-gray-600">Complete once and it's done</div>
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Helper to get points for difficulty
    const getPointsForDifficulty = (difficulty) => {
      switch (difficulty) {
        case 'easy': return 1;
        case 'medium': return 2;
        case 'hard': return 3;
        default: return 1;
      }
    };

    // Task Form Modal
    function TaskFormModal({ type, onClose, onSubmit, onDelete, existingTask }) {
      const [taskName, setTaskName] = useState(existingTask?.text || '');
      const [frequencyValue, setFrequencyValue] = useState(existingTask?.frequencyValue || 1);
      const [frequencyUnit, setFrequencyUnit] = useState(existingTask?.frequencyUnit || 'days');
      const [difficulty, setDifficulty] = useState(existingTask?.difficulty || 'easy');

      const isEditing = !!existingTask;

      const handleSubmit = (e) => {
        e.preventDefault();
        const taskData = {
          text: taskName,
          type: type,
          difficulty: difficulty,
        };

        if (type === 'recurring') {
          taskData.frequencyValue = frequencyValue;
          taskData.frequencyUnit = frequencyUnit;
        }

        onSubmit(taskData);
      };

      const getTitle = () => {
        const prefix = isEditing ? 'Edit' : 'Create';
        switch (type) {
          case 'on-demand': return `${prefix} On Demand Task`;
          case 'recurring': return `${prefix} Recurring Task`;
          case 'one-time': return `${prefix} One-time Task`;
          default: return 'New Task';
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-gray-800">{getTitle()}</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X />
              </button>
            </div>
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Task Name
                </label>
                <input
                  type="text"
                  value={taskName}
                  onChange={(e) => setTaskName(e.target.value)}
                  required
                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="e.g., Clean bathroom"
                />
              </div>

              {type === 'recurring' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Frequency
                  </label>
                  <div className="flex gap-2">
                    <input
                      type="number"
                      value={frequencyValue}
                      onChange={(e) => setFrequencyValue(parseInt(e.target.value))}
                      min="1"
                      required
                      className="w-24 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <select
                      value={frequencyUnit}
                      onChange={(e) => setFrequencyUnit(e.target.value)}
                      className="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="hours">Hours</option>
                      <option value="days">Days</option>
                      <option value="weeks">Weeks</option>
                      <option value="months">Months</option>
                      <option value="years">Years</option>
                    </select>
                  </div>
                </div>
              )}

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Difficulty
                </label>
                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={() => setDifficulty('easy')}
                    className={`flex-1 py-2 px-3 rounded-lg border-2 transition ${
                      difficulty === 'easy'
                        ? 'border-green-500 bg-green-50 text-green-700'
                        : 'border-gray-200 text-gray-600 hover:border-gray-300'
                    }`}
                  >
                    <div className="font-medium">Easy</div>
                    <div className="text-xs">1 pt</div>
                  </button>
                  <button
                    type="button"
                    onClick={() => setDifficulty('medium')}
                    className={`flex-1 py-2 px-3 rounded-lg border-2 transition ${
                      difficulty === 'medium'
                        ? 'border-yellow-500 bg-yellow-50 text-yellow-700'
                        : 'border-gray-200 text-gray-600 hover:border-gray-300'
                    }`}
                  >
                    <div className="font-medium">Medium</div>
                    <div className="text-xs">2 pts</div>
                  </button>
                  <button
                    type="button"
                    onClick={() => setDifficulty('hard')}
                    className={`flex-1 py-2 px-3 rounded-lg border-2 transition ${
                      difficulty === 'hard'
                        ? 'border-red-500 bg-red-50 text-red-700'
                        : 'border-gray-200 text-gray-600 hover:border-gray-300'
                    }`}
                  >
                    <div className="font-medium">Hard</div>
                    <div className="text-xs">3 pts</div>
                  </button>
                </div>
              </div>

              <div className="flex gap-2">
                <button
                  type="button"
                  onClick={onClose}
                  className="flex-1 px-4 py-3 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 transition"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                >
                  {isEditing ? 'Save' : 'Create'}
                </button>
              </div>

              {isEditing && onDelete && (
                <button
                  type="button"
                  onClick={() => {
                    if (confirm('Are you sure you want to delete this task?')) {
                      onDelete();
                    }
                  }}
                  className="w-full px-4 py-3 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition flex items-center justify-center gap-2"
                >
                  <Trash />
                  <span>Delete Task</span>
                </button>
              )}
            </form>
          </div>
        </div>
      );
    }

    // Profile Modal
    function ProfileModal({ onClose, currentProfile, userEmail, onSave, onLogout }) {
      const [isEditing, setIsEditing] = useState(false);
      const [firstName, setFirstName] = useState(currentProfile?.firstName || '');
      const [lastName, setLastName] = useState(currentProfile?.lastName || '');

      const displayName = (currentProfile?.firstName || currentProfile?.lastName)
        ? `${currentProfile?.firstName || ''} ${currentProfile?.lastName || ''}`.trim()
        : null;

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave({ firstName: firstName.trim(), lastName: lastName.trim() });
        setIsEditing(false);
      };

      const handleStartEdit = () => {
        setFirstName(currentProfile?.firstName || '');
        setLastName(currentProfile?.lastName || '');
        setIsEditing(true);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-gray-800">
                {isEditing ? 'Edit Profile' : 'Profile'}
              </h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X />
              </button>
            </div>

            {isEditing ? (
              <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    First Name
                  </label>
                  <input
                    type="text"
                    value={firstName}
                    onChange={(e) => setFirstName(e.target.value)}
                    className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter your first name"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Last Name
                  </label>
                  <input
                    type="text"
                    value={lastName}
                    onChange={(e) => setLastName(e.target.value)}
                    className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Enter your last name"
                  />
                </div>

                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={() => setIsEditing(false)}
                    className="flex-1 px-4 py-3 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 transition"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    className="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                  >
                    Save
                  </button>
                </div>
              </form>
            ) : (
              <div className="space-y-4">
                <div className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                  <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <User />
                  </div>
                  <div className="flex-1 min-w-0">
                    {displayName ? (
                      <>
                        <div className="font-semibold text-gray-800 truncate">{displayName}</div>
                        <div className="text-sm text-gray-500 truncate">{userEmail}</div>
                      </>
                    ) : (
                      <div className="font-medium text-gray-800 truncate">{userEmail}</div>
                    )}
                  </div>
                </div>

                <button
                  onClick={handleStartEdit}
                  className="w-full px-4 py-3 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 transition flex items-center justify-center gap-2"
                >
                  <Edit />
                  <span>Edit Profile</span>
                </button>

                <button
                  onClick={onLogout}
                  className="w-full px-4 py-3 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition flex items-center justify-center gap-2"
                >
                  <LogOut />
                  <span>Log Out</span>
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Task Item Component
    function TaskItem({ task, onToggle, onEdit, showOwner, isOwner, ownerName }) {
      const isRecurring = task.type === 'recurring';
      const progress = isRecurring ? calculateProgress(task.lastCompleted, task.frequencyValue, task.frequencyUnit) : null;

      let progressColor = 'bg-blue-500';
      if (progress !== null && progress < 20) {
        progressColor = 'bg-red-500';
      }

      const getDifficultyBadge = () => {
        const difficulty = task.difficulty || 'easy';
        const points = getPointsForDifficulty(difficulty);
        return (
          <span className="text-xs px-2 py-0.5 rounded-full bg-blue-200 text-blue-600">
            {points} pt{points > 1 ? 's' : ''}
          </span>
        );
      };

      return (
        <div className="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition">
          <div className="flex items-start gap-3">
            <button
              onClick={() => onToggle(task.id, task)}
              className="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center hover:border-green-500 transition flex-shrink-0 mt-1"
            >
              {task.completed && <Check />}
            </button>

            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="text-gray-800 font-medium">{task.text}</span>
                {getDifficultyBadge()}
              </div>
              {showOwner && (
                <div className="text-xs text-gray-500 mt-1">
                  {isOwner ? 'You' : ownerName}
                </div>
              )}
              {task.lastCompleted && (
                <div className="text-xs text-gray-500 mt-1">
                  Last completed: {formatDate(task.lastCompleted)}
                </div>
              )}
              
              {isRecurring && (
                <div className="mt-2">
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div
                      className={`${progressColor} h-2 rounded-full transition-all duration-300`}
                      style={{ width: `${progress}%` }}
                    />
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    Every {task.frequencyValue} {task.frequencyUnit}
                  </div>
                </div>
              )}
            </div>

            {(!showOwner || isOwner) && (
              <button
                onClick={() => onEdit(task)}
                className="text-gray-500 hover:text-gray-700 p-2 flex-shrink-0"
              >
                <Edit />
              </button>
            )}
          </div>
        </div>
      );
    }

    // Leaderboard Component
    function Leaderboard({ currentUserEmail, profiles }) {
      const [leaderboard, setLeaderboard] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        if (!db) return;

        const pointsRef = db.ref('userPoints');
        pointsRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            const entries = Object.entries(data)
              .map(([key, points]) => ({
                email: key.replace(/_/g, '.'),
                points: points
              }))
              .sort((a, b) => b.points - a.points);
            setLeaderboard(entries);
          } else {
            setLeaderboard([]);
          }
          setLoading(false);
        });

        return () => pointsRef.off();
      }, []);

      if (loading) {
        return (
          <div className="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
            Loading leaderboard...
          </div>
        );
      }

      if (leaderboard.length === 0) {
        return (
          <div className="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
            No points earned yet. Complete some tasks to get on the leaderboard!
          </div>
        );
      }

      return (
        <div className="bg-white rounded-2xl shadow-lg p-4">
          <h2 className="text-lg font-semibold text-gray-700 mb-3">Leaderboard</h2>
          <div className="space-y-2">
            {leaderboard.map((entry, index) => {
              const isCurrentUser = entry.email === currentUserEmail;
              const rank = index + 1;
              let rankBg = 'bg-gray-100';
              let rankText = 'text-gray-600';

              if (rank === 1) {
                rankBg = 'bg-yellow-100';
                rankText = 'text-yellow-700';
              } else if (rank === 2) {
                rankBg = 'bg-gray-200';
                rankText = 'text-gray-600';
              } else if (rank === 3) {
                rankBg = 'bg-orange-100';
                rankText = 'text-orange-700';
              }

              return (
                <div
                  key={entry.email}
                  className={`flex items-center gap-3 p-3 rounded-lg ${isCurrentUser ? 'bg-blue-50 border-2 border-blue-200' : 'bg-gray-50'}`}
                >
                  <div className={`w-8 h-8 rounded-full ${rankBg} ${rankText} flex items-center justify-center font-bold text-sm`}>
                    {rank}
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className={`font-medium truncate ${isCurrentUser ? 'text-blue-800' : 'text-gray-800'}`}>
                      {getDisplayName(entry.email, profiles)}
                      {isCurrentUser && <span className="text-xs ml-2 text-blue-600">(you)</span>}
                    </div>
                  </div>
                  <div className="flex items-center gap-1 bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full">
                    <span className="font-bold">{entry.points}</span>
                    <span className="text-sm">pts</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Main App Component
    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [tasks, setTasks] = useState([]);
      const [points, setPoints] = useState(0);
      const [profiles, setProfiles] = useState({});
      const [currentPage, setCurrentPage] = useState('tasks');
      const [taskView, setTaskView] = useState('mine');
      const [showTaskTypeModal, setShowTaskTypeModal] = useState(false);
      const [showTaskFormModal, setShowTaskFormModal] = useState(false);
      const [showProfileModal, setShowProfileModal] = useState(false);
      const [selectedTaskType, setSelectedTaskType] = useState(null);
      const [editingTask, setEditingTask] = useState(null);

      useEffect(() => {
        if (!auth) {
          setLoading(false);
          return;
        }

        const unsubscribe = auth.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return unsubscribe;
      }, []);

      useEffect(() => {
        if (!user || !db) return;

        const tasksRef = db.ref('tasks');

        tasksRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            const tasksArray = Object.keys(data)
              .map(key => ({
                id: key,
                ...data[key]
              }))
              .filter(task => {
                // Don't show completed one-time tasks
                if (task.type === 'one-time' && task.completed) return false;
                return true;
              })
              .sort((a, b) => {
                // Sort by creation time
                return (b.createdAt || 0) - (a.createdAt || 0);
              });
            setTasks(tasksArray);
          } else {
            setTasks([]);
          }
        });

        return () => tasksRef.off();
      }, [user]);

      useEffect(() => {
        if (!user || !db) return;

        // Use a sanitized version of email as the key
        const userKey = user.email.replace(/[.#$[\]]/g, '_');
        const pointsRef = db.ref(`userPoints/${userKey}`);

        pointsRef.on('value', (snapshot) => {
          setPoints(snapshot.val() || 0);
        });

        return () => pointsRef.off();
      }, [user]);

      useEffect(() => {
        if (!db) return;

        const profilesRef = db.ref('userProfiles');
        profilesRef.on('value', (snapshot) => {
          setProfiles(snapshot.val() || {});
        });

        return () => profilesRef.off();
      }, []);

      const handleLogout = async () => {
        try {
          await auth.signOut();
        } catch (error) {
          console.error('Logout error:', error);
        }
      };

      const handleSaveProfile = (profileData) => {
        if (db && user) {
          const userKey = user.email.replace(/[.#$[\]]/g, '_');
          db.ref(`userProfiles/${userKey}`).set(profileData);
          setShowProfileModal(false);
        }
      };

      const getCurrentUserProfile = () => {
        if (!user) return {};
        const userKey = user.email.replace(/[.#$[\]]/g, '_');
        return profiles[userKey] || {};
      };

      const handleTaskTypeSelect = (type) => {
        setSelectedTaskType(type);
        setShowTaskTypeModal(false);
        setShowTaskFormModal(true);
      };

      const handleTaskSubmit = (taskData) => {
        if (db && user) {
          if (editingTask) {
            // Update existing task
            db.ref(`tasks/${editingTask.id}`).update({
              ...taskData,
            });
          } else {
            // Create new task
            const tasksRef = db.ref('tasks');
            const newTaskRef = tasksRef.push();
            newTaskRef.set({
              ...taskData,
              completed: false,
              createdBy: user.email,
              createdAt: Date.now(),
              lastCompleted: null,
            });
          }
          setShowTaskFormModal(false);
          setSelectedTaskType(null);
          setEditingTask(null);
        }
      };

      const handleEditTask = (task) => {
        setEditingTask(task);
        setSelectedTaskType(task.type);
        setShowTaskFormModal(true);
      };

      const handleDeleteTask = () => {
        if (editingTask && db) {
          db.ref(`tasks/${editingTask.id}`).remove();
          setShowTaskFormModal(false);
          setEditingTask(null);
          setSelectedTaskType(null);
        }
      };

      const toggleTask = (taskId, task) => {
        if (db && user) {
          // Award points based on difficulty
          const earnedPoints = getPointsForDifficulty(task.difficulty);
          const userKey = user.email.replace(/[.#$[\]]/g, '_');
          db.ref(`userPoints/${userKey}`).set(points + earnedPoints);

          if (task.type === 'one-time') {
            // One-time tasks just get marked as completed
            db.ref(`tasks/${taskId}`).update({
              completed: true,
              lastCompleted: Date.now(),
            });
          } else {
            // On-demand and recurring tasks update last completion
            db.ref(`tasks/${taskId}`).update({
              lastCompleted: Date.now(),
            });
          }
        }
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-lg text-gray-600">Loading...</div>
          </div>
        );
      }

      if (!user) {
        return <LoginScreen />;
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 pb-20">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
              <div className="flex items-center justify-between mb-4">
                <h1 className="text-3xl font-bold text-gray-800">Chore Tracker</h1>
                <button
                  onClick={() => setShowProfileModal(true)}
                  className="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition"
                  title="Profile"
                >
                  <User />
                </button>
              </div>

              <div className="flex items-center justify-between">
                <div className="text-sm text-gray-600">
                  {getDisplayName(user.email, profiles)}
                </div>
                <div className="flex items-center gap-1 bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full">
                  <span className="font-bold">{points}</span>
                  <span className="text-sm">pts</span>
                </div>
              </div>

              <div className="flex gap-2 mt-4">
                <button
                  onClick={() => setCurrentPage('tasks')}
                  className={`flex-1 flex items-center justify-center gap-2 py-2 px-4 rounded-lg transition ${
                    currentPage === 'tasks'
                      ? 'bg-blue-500 text-white'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  <ListTodo />
                  <span>Tasks</span>
                </button>
                <button
                  onClick={() => setCurrentPage('leaderboard')}
                  className={`flex-1 flex items-center justify-center gap-2 py-2 px-4 rounded-lg transition ${
                    currentPage === 'leaderboard'
                      ? 'bg-blue-500 text-white'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  <Trophy />
                  <span>Leaderboard</span>
                </button>
              </div>
            </div>

            {currentPage === 'tasks' && (
              <>
                {(() => {
                  const filteredTasks = taskView === 'mine'
                    ? tasks.filter(task => task.createdBy === user.email)
                    : tasks;

                  return filteredTasks.length > 0 ? (
                    <div className="bg-white rounded-2xl shadow-lg p-4">
                      <div className="flex items-center justify-between mb-3">
                        <h2 className="text-lg font-semibold text-gray-700">
                          {taskView === 'mine' ? 'My Tasks' : "Everyone's Tasks"}
                        </h2>
                        <div className="flex bg-gray-100 rounded-lg p-1">
                          <button
                            onClick={() => setTaskView('mine')}
                            className={`px-3 py-1 text-sm rounded-md transition ${
                              taskView === 'mine'
                                ? 'bg-white shadow text-gray-800'
                                : 'text-gray-500 hover:text-gray-700'
                            }`}
                          >
                            Mine
                          </button>
                          <button
                            onClick={() => setTaskView('everyone')}
                            className={`px-3 py-1 text-sm rounded-md transition ${
                              taskView === 'everyone'
                                ? 'bg-white shadow text-gray-800'
                                : 'text-gray-500 hover:text-gray-700'
                            }`}
                          >
                            Everyone
                          </button>
                        </div>
                      </div>
                      <div className="space-y-2">
                        {filteredTasks.map(task => (
                          <TaskItem
                            key={task.id}
                            task={task}
                            onToggle={toggleTask}
                            onEdit={handleEditTask}
                            showOwner={taskView === 'everyone'}
                            isOwner={task.createdBy === user.email}
                            ownerName={getDisplayName(task.createdBy, profiles)}
                          />
                        ))}
                      </div>
                    </div>
                  ) : (
                    <div className="bg-white rounded-2xl shadow-lg p-4">
                      <div className="flex items-center justify-between mb-3">
                        <h2 className="text-lg font-semibold text-gray-700">
                          {taskView === 'mine' ? 'My Tasks' : "Everyone's Tasks"}
                        </h2>
                        <div className="flex bg-gray-100 rounded-lg p-1">
                          <button
                            onClick={() => setTaskView('mine')}
                            className={`px-3 py-1 text-sm rounded-md transition ${
                              taskView === 'mine'
                                ? 'bg-white shadow text-gray-800'
                                : 'text-gray-500 hover:text-gray-700'
                            }`}
                          >
                            Mine
                          </button>
                          <button
                            onClick={() => setTaskView('everyone')}
                            className={`px-3 py-1 text-sm rounded-md transition ${
                              taskView === 'everyone'
                                ? 'bg-white shadow text-gray-800'
                                : 'text-gray-500 hover:text-gray-700'
                            }`}
                          >
                            Everyone
                          </button>
                        </div>
                      </div>
                      <div className="text-center text-gray-500 py-4">
                        {taskView === 'mine'
                          ? "No tasks yet. Tap the + button to get started!"
                          : "No tasks from anyone yet."}
                      </div>
                    </div>
                  );
                })()}

                <div className="sticky bottom-4 flex justify-end mt-4">
                  <button
                    onClick={() => setShowTaskTypeModal(true)}
                    className="w-12 h-12 flex items-center justify-center bg-blue-500 text-white rounded-full shadow-lg hover:bg-blue-600 transition"
                  >
                    <Plus />
                  </button>
                </div>
              </>
            )}

            {currentPage === 'leaderboard' && (
              <Leaderboard currentUserEmail={user.email} profiles={profiles} />
            )}
          </div>

          {showTaskTypeModal && (
            <TaskTypeModal
              onClose={() => setShowTaskTypeModal(false)}
              onSelect={handleTaskTypeSelect}
            />
          )}

          {showTaskFormModal && (
            <TaskFormModal
              type={selectedTaskType}
              existingTask={editingTask}
              onClose={() => {
                setShowTaskFormModal(false);
                setSelectedTaskType(null);
                setEditingTask(null);
              }}
              onSubmit={handleTaskSubmit}
              onDelete={editingTask ? handleDeleteTask : null}
            />
          )}

          {showProfileModal && (
            <ProfileModal
              onClose={() => setShowProfileModal(false)}
              currentProfile={getCurrentUserProfile()}
              userEmail={user.email}
              onSave={handleSaveProfile}
              onLogout={handleLogout}
            />
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>