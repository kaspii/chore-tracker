<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3B82F6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Chore Tracker</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const firebaseConfig = {
        apiKey: "AIzaSyAD5e1HimKsCRqOPPUYEDzFW4iC5eLEUP8",
        authDomain: "chore-tracker-28aac.firebaseapp.com",
        databaseURL: "https://chore-tracker-28aac-default-rtdb.firebaseio.com",
        projectId: "chore-tracker-28aac",
        storageBucket: "chore-tracker-28aac.firebasestorage.app",
        messagingSenderId: "243193335376",
        appId: "1:243193335376:web:f3d716211b914aa8304b55"
    };

    // Initialize Firebase
    let auth, db;
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      auth = firebase.auth();
      db = firebase.database();
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }

    // Icons
    const Check = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    );

    const Plus = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const Trash = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );

    const Edit = () => (
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
      </svg>
    );

    const LogOut = () => (
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
    );

    const X = () => (
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    // Helper functions
    const formatDate = (timestamp) => {
      if (!timestamp) return null;
      const date = new Date(timestamp);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      return `${month}/${day}/${year}`;
    };

    const calculateProgress = (lastCompleted, frequencyValue, frequencyUnit) => {
      if (!lastCompleted) return 0;
      
      const now = Date.now();
      const timeSinceCompletion = now - lastCompleted;
      
      // Convert frequency to milliseconds
      let frequencyMs;
      switch (frequencyUnit) {
        case 'hours':
          frequencyMs = frequencyValue * 60 * 60 * 1000;
          break;
        case 'days':
          frequencyMs = frequencyValue * 24 * 60 * 60 * 1000;
          break;
        case 'weeks':
          frequencyMs = frequencyValue * 7 * 24 * 60 * 60 * 1000;
          break;
        case 'months':
          frequencyMs = frequencyValue * 30 * 24 * 60 * 60 * 1000;
          break;
        case 'years':
          frequencyMs = frequencyValue * 365 * 24 * 60 * 60 * 1000;
          break;
        default:
          frequencyMs = frequencyValue * 24 * 60 * 60 * 1000;
      }
      
      const progress = 100 - (timeSinceCompletion / frequencyMs) * 100;
      return Math.max(0, Math.min(100, progress));
    };

    // Login Component
    function LoginScreen() {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [isSignUp, setIsSignUp] = useState(false);
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (isSignUp) {
            await auth.createUserWithEmailAndPassword(email, password);
          } else {
            await auth.signInWithEmailAndPassword(email, password);
          }
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <h1 className="text-3xl font-bold text-gray-800 mb-2 text-center">
              Chore Tracker
            </h1>
            <p className="text-gray-600 mb-6 text-center">
              {isSignUp ? 'Create your account' : 'Sign in to continue'}
            </p>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Email
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="you@example.com"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Password
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  minLength="6"
                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="••••••••"
                />
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition disabled:opacity-50"
              >
                {loading ? 'Please wait...' : (isSignUp ? 'Sign Up' : 'Sign In')}
              </button>
            </form>

            <div className="mt-4 text-center">
              <button
                onClick={() => {
                  setIsSignUp(!isSignUp);
                  setError('');
                }}
                className="text-blue-600 hover:text-blue-700 text-sm font-medium"
              >
                {isSignUp ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Task Type Selection Modal
    function TaskTypeModal({ onClose, onSelect }) {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-gray-800">Create New Task</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X />
              </button>
            </div>
            
            <div className="space-y-3">
              <button
                onClick={() => onSelect('on-demand')}
                className="w-full p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition"
              >
                <div className="font-semibold text-gray-800 mb-1">On Demand</div>
                <div className="text-sm text-gray-600">Complete as needed, tracks last completion</div>
              </button>
              
              <button
                onClick={() => onSelect('recurring')}
                className="w-full p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition"
              >
                <div className="font-semibold text-gray-800 mb-1">Recurring</div>
                <div className="text-sm text-gray-600">Set a frequency for regular completion</div>
              </button>
              
              <button
                onClick={() => onSelect('one-time')}
                className="w-full p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition"
              >
                <div className="font-semibold text-gray-800 mb-1">One-time</div>
                <div className="text-sm text-gray-600">Complete once and it's done</div>
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Task Form Modal
    function TaskFormModal({ type, onClose, onSubmit, onDelete, existingTask }) {
      const [taskName, setTaskName] = useState(existingTask?.text || '');
      const [frequencyValue, setFrequencyValue] = useState(existingTask?.frequencyValue || 1);
      const [frequencyUnit, setFrequencyUnit] = useState(existingTask?.frequencyUnit || 'days');

      const isEditing = !!existingTask;

      const handleSubmit = (e) => {
        e.preventDefault();
        const taskData = {
          text: taskName,
          type: type,
        };

        if (type === 'recurring') {
          taskData.frequencyValue = frequencyValue;
          taskData.frequencyUnit = frequencyUnit;
        }

        onSubmit(taskData);
      };

      const getTitle = () => {
        const prefix = isEditing ? 'Edit' : 'Create';
        switch (type) {
          case 'on-demand': return `${prefix} On Demand Task`;
          case 'recurring': return `${prefix} Recurring Task`;
          case 'one-time': return `${prefix} One-time Task`;
          default: return 'New Task';
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl font-bold text-gray-800">{getTitle()}</h2>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X />
              </button>
            </div>
            
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Task Name
                </label>
                <input
                  type="text"
                  value={taskName}
                  onChange={(e) => setTaskName(e.target.value)}
                  required
                  className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="e.g., Clean bathroom"
                />
              </div>

              {type === 'recurring' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Frequency
                  </label>
                  <div className="flex gap-2">
                    <input
                      type="number"
                      value={frequencyValue}
                      onChange={(e) => setFrequencyValue(parseInt(e.target.value))}
                      min="1"
                      required
                      className="w-24 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <select
                      value={frequencyUnit}
                      onChange={(e) => setFrequencyUnit(e.target.value)}
                      className="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="hours">Hours</option>
                      <option value="days">Days</option>
                      <option value="weeks">Weeks</option>
                      <option value="months">Months</option>
                      <option value="years">Years</option>
                    </select>
                  </div>
                </div>
              )}

              <div className="flex gap-2">
                <button
                  type="button"
                  onClick={onClose}
                  className="flex-1 px-4 py-3 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 transition"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="flex-1 px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                >
                  {isEditing ? 'Save' : 'Create'}
                </button>
              </div>

              {isEditing && onDelete && (
                <button
                  type="button"
                  onClick={() => {
                    if (confirm('Are you sure you want to delete this task?')) {
                      onDelete();
                    }
                  }}
                  className="w-full px-4 py-3 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition flex items-center justify-center gap-2"
                >
                  <Trash />
                  <span>Delete Task</span>
                </button>
              )}
            </form>
          </div>
        </div>
      );
    }

    // Task Item Component
    function TaskItem({ task, onToggle, onEdit }) {
      const isRecurring = task.type === 'recurring';
      const progress = isRecurring ? calculateProgress(task.lastCompleted, task.frequencyValue, task.frequencyUnit) : null;
      
      let progressColor = 'bg-blue-500';
      if (progress !== null && progress < 20) {
        progressColor = 'bg-red-500';
      }

      return (
        <div className="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition">
          <div className="flex items-start gap-3">
            <button
              onClick={() => onToggle(task.id, task)}
              className="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center hover:border-green-500 transition flex-shrink-0 mt-1"
            >
              {task.completed && <Check />}
            </button>
            
            <div className="flex-1 min-w-0">
              <div className="text-gray-800 font-medium">{task.text}</div>
              {task.lastCompleted && (
                <div className="text-xs text-gray-500 mt-1">
                  Last completed: {formatDate(task.lastCompleted)}
                </div>
              )}
              
              {isRecurring && (
                <div className="mt-2">
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div
                      className={`${progressColor} h-2 rounded-full transition-all duration-300`}
                      style={{ width: `${progress}%` }}
                    />
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    Every {task.frequencyValue} {task.frequencyUnit}
                  </div>
                </div>
              )}
            </div>

            <button
              onClick={() => onEdit(task)}
              className="text-gray-500 hover:text-gray-700 p-2 flex-shrink-0"
            >
              <Edit />
            </button>
          </div>
        </div>
      );
    }

    // Main App Component
    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [tasks, setTasks] = useState([]);
      const [showTaskTypeModal, setShowTaskTypeModal] = useState(false);
      const [showTaskFormModal, setShowTaskFormModal] = useState(false);
      const [selectedTaskType, setSelectedTaskType] = useState(null);
      const [editingTask, setEditingTask] = useState(null);

      useEffect(() => {
        if (!auth) {
          setLoading(false);
          return;
        }

        const unsubscribe = auth.onAuthStateChanged((user) => {
          setUser(user);
          setLoading(false);
        });
        return unsubscribe;
      }, []);

      useEffect(() => {
        if (!user || !db) return;

        const tasksRef = db.ref('tasks');
        
        tasksRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            const tasksArray = Object.keys(data)
              .map(key => ({
                id: key,
                ...data[key]
              }))
              .filter(task => {
                // Filter to only show this user's tasks
                // Don't show completed one-time tasks
                if (task.type === 'one-time' && task.completed) return false;
                return task.createdBy === user.email;
              })
              .sort((a, b) => {
                // Sort by creation time
                return (b.createdAt || 0) - (a.createdAt || 0);
              });
            setTasks(tasksArray);
          } else {
            setTasks([]);
          }
        });

        return () => tasksRef.off();
      }, [user]);

      const handleLogout = async () => {
        try {
          await auth.signOut();
        } catch (error) {
          console.error('Logout error:', error);
        }
      };

      const handleTaskTypeSelect = (type) => {
        setSelectedTaskType(type);
        setShowTaskTypeModal(false);
        setShowTaskFormModal(true);
      };

      const handleTaskSubmit = (taskData) => {
        if (db && user) {
          if (editingTask) {
            // Update existing task
            db.ref(`tasks/${editingTask.id}`).update({
              ...taskData,
            });
          } else {
            // Create new task
            const tasksRef = db.ref('tasks');
            const newTaskRef = tasksRef.push();
            newTaskRef.set({
              ...taskData,
              completed: false,
              createdBy: user.email,
              createdAt: Date.now(),
              lastCompleted: null,
            });
          }
          setShowTaskFormModal(false);
          setSelectedTaskType(null);
          setEditingTask(null);
        }
      };

      const handleEditTask = (task) => {
        setEditingTask(task);
        setSelectedTaskType(task.type);
        setShowTaskFormModal(true);
      };

      const handleDeleteTask = () => {
        if (editingTask && db) {
          db.ref(`tasks/${editingTask.id}`).remove();
          setShowTaskFormModal(false);
          setEditingTask(null);
          setSelectedTaskType(null);
        }
      };

      const toggleTask = (taskId, task) => {
        if (db && user) {
          if (task.type === 'one-time') {
            // One-time tasks just get marked as completed
            db.ref(`tasks/${taskId}`).update({
              completed: true,
              lastCompleted: Date.now(),
            });
          } else {
            // On-demand and recurring tasks update last completion
            db.ref(`tasks/${taskId}`).update({
              lastCompleted: Date.now(),
            });
          }
        }
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-lg text-gray-600">Loading...</div>
          </div>
        );
      }

      if (!user) {
        return <LoginScreen />;
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 pb-20">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
              <div className="flex items-center justify-between mb-4">
                <h1 className="text-3xl font-bold text-gray-800">Chore Tracker</h1>
                <button
                  onClick={handleLogout}
                  className="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition"
                  title="Sign out"
                >
                  <LogOut />
                </button>
              </div>

              <div className="text-sm text-gray-600">
                Signed in as: {user.email}
              </div>
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-4 mb-4">
              <button
                onClick={() => setShowTaskTypeModal(true)}
                className="w-full flex items-center justify-center gap-2 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition"
              >
                <Plus />
                <span>Add New Task</span>
              </button>
            </div>

            {tasks.length > 0 ? (
              <div className="bg-white rounded-2xl shadow-lg p-4">
                <h2 className="text-lg font-semibold text-gray-700 mb-3">My Tasks</h2>
                <div className="space-y-2">
                  {tasks.map(task => (
                    <TaskItem
                      key={task.id}
                      task={task}
                      onToggle={toggleTask}
                      onEdit={handleEditTask}
                    />
                  ))}
                </div>
              </div>
            ) : (
              <div className="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
                No tasks yet. Click "Add New Task" to get started!
              </div>
            )}
          </div>

          {showTaskTypeModal && (
            <TaskTypeModal
              onClose={() => setShowTaskTypeModal(false)}
              onSelect={handleTaskTypeSelect}
            />
          )}

          {showTaskFormModal && (
            <TaskFormModal
              type={selectedTaskType}
              existingTask={editingTask}
              onClose={() => {
                setShowTaskFormModal(false);
                setSelectedTaskType(null);
                setEditingTask(null);
              }}
              onSubmit={handleTaskSubmit}
              onDelete={editingTask ? handleDeleteTask : null}
            />
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>